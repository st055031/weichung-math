<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自訂係數配方法 (垂直分數版)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2e7d32; 
            --secondary-color: #e67e22;
            --bg-light: #f4f7f6;
            --text-dark: #333;
            --white: #ffffff;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0; padding: 0; background-color: var(--bg-light);
            color: var(--text-dark); line-height: 1.6;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        .main-layout { display: flex; flex: 1; height: 100%; }

        .canvas-area {
            flex: 2; background: white;
            display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start;
            padding: 20px; border-right: 1px solid #ddd;
            overflow-y: auto;
        }

        .controls-area {
            flex: 1; background: #fafafa; padding: 20px;
            display: flex; flex-direction: column; gap: 20px;
            overflow-y: auto; min-width: 320px;
        }

        .fraction-group {
            display: flex; align-items: center; gap: 10px;
            background: white; padding: 15px; border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .coeff-label { font-weight: bold; font-size: 1.2em; width: 30px; }
        
        .fraction-input {
            display: flex; flex-direction: column; align-items: center; width: 60px;
        }
        .fraction-input input {
            width: 100%; text-align: center; border: 1px solid #ccc;
            border-radius: 4px; padding: 4px; font-size: 16px;
        }
        .fraction-line { width: 100%; height: 2px; background: #333; margin: 4px 0; }

        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        button {
            padding: 10px 20px; font-size: 16px; cursor: pointer;
            background-color: var(--primary-color); color: white;
            border: none; border-radius: 5px; font-weight: bold;
        }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button#resetBtn { background-color: #757575; }

        .explanation-box {
            margin-top: auto; padding: 15px; background: #e8f5e9;
            border-radius: 8px; border-left: 4px solid var(--primary-color);
            font-size: 0.9em; width: 90%;
        }

        #canvas-wrapper { width: 100%; display: flex; justify-content: center; margin-bottom: 20px; }

        @media (max-width: 768px) {
            .main-layout { flex-direction: column-reverse; }
            .canvas-area { flex: 1; border-right: none; border-top: 1px solid #ddd; }
        }
    </style>
</head>
<body>

    <div class="main-layout">
        <div class="canvas-area">
            <h2 style="color: var(--primary-color); margin-bottom: 10px;">配方法動態演示 (垂直分數)</h2>
            <div id="canvas-wrapper"></div>
            <div class="explanation-box">
                <b>當前步驟：</b> <span id="step-desc">準備開始...</span>
            </div>
        </div>

        <div class="controls-area">
            <h3 style="margin-top:0"><i class="fas fa-sliders-h"></i> 設定係數 (分數)</h3>
            
            <div class="fraction-group">
                <div class="coeff-label">a =</div>
                <div class="fraction-input">
                    <input type="number" id="a_num" value="2" onchange="updateMath()">
                    <div class="fraction-line"></div>
                    <input type="number" id="a_den" value="1" onchange="updateMath()">
                </div>
            </div>

            <div class="fraction-group">
                <div class="coeff-label">b =</div>
                <div class="fraction-input">
                    <input type="number" id="b_num" value="-3" onchange="updateMath()">
                    <div class="fraction-line"></div>
                    <input type="number" id="b_den" value="1" onchange="updateMath()">
                </div>
            </div>

            <div class="fraction-group">
                <div class="coeff-label">c =</div>
                <div class="fraction-input">
                    <input type="number" id="c_num" value="1" onchange="updateMath()">
                    <div class="fraction-line"></div>
                    <input type="number" id="c_den" value="1" onchange="updateMath()">
                </div>
            </div>

            <div class="btn-group">
                <button id="prevBtn" onclick="prevStep()">上一步</button>
                <button id="nextBtn" onclick="nextStep()">下一步</button>
            </div>
            <div class="btn-group">
                <button id="resetBtn" onclick="resetAnimation()" style="width:100%">重置步驟</button>
            </div>
        </div>
    </div>

    <script>
        // 分數類別
        class Fraction {
            constructor(n, d) {
                if (d === 0) { d = 1; }
                if (d < 0) { n = -n; d = -d; }
                this.n = parseInt(n);
                this.d = parseInt(d);
                this.simplify();
            }
            simplify() {
                const gcd = (a, b) => b ? gcd(b, a % b) : Math.abs(a);
                let common = gcd(this.n, this.d);
                this.n /= common;
                this.d /= common;
            }
            val() { return this.n / this.d; }
            add(f) { return new Fraction(this.n * f.d + f.n * this.d, this.d * f.d); }
            sub(f) { return new Fraction(this.n * f.d - f.n * this.d, this.d * f.d); }
            mul(f) { return new Fraction(this.n * f.n, this.d * f.d); }
            div(f) { return new Fraction(this.n * f.d, this.d * f.n); }
            sq()   { return new Fraction(this.n * this.n, this.d * this.d); }
            abs()  { return new Fraction(Math.abs(this.n), this.d); }
        }

        let step = 0;
        let totalSteps = 4;
        let A, B, C, B_div_A, Half_B, Half_B_Sq, Balance, Final_K;

        function setup() {
            let canvas = createCanvas(600, 480);
            canvas.parent('canvas-wrapper');
            textFont('Noto Sans TC');
            updateMath();
        }

        function windowResized() {
            let w = document.querySelector('.canvas-area').clientWidth - 40;
            resizeCanvas(min(w, 700), 480);
        }

        function updateMath() {
            let getVal = (id) => document.getElementById(id).value;
            A = new Fraction(getVal('a_num'), getVal('a_den'));
            B = new Fraction(getVal('b_num'), getVal('b_den'));
            C = new Fraction(getVal('c_num'), getVal('c_den'));

            B_div_A = B.div(A);
            Half_B = B_div_A.div(new Fraction(2, 1));
            Half_B_Sq = Half_B.sq();
            Balance = A.mul(Half_B_Sq);
            Final_K = C.sub(Balance);
            redraw();
        }

        // --- 核心：繪製垂直分數的函式 ---
        // 回傳：物件佔用的寬度，並將繪製中心點透過 return 物件傳回 (方便畫箭頭)
        function drawVerticalFraction(f, x, y, options = {}) {
            let { showSign = false, color = 0, fontSize = 24 } = options;
            
            fill(color); stroke(0); strokeWeight(0); 
            textSize(fontSize);
            
            let val = f.val();
            let absN = Math.abs(f.n);
            let absD = Math.abs(f.d);
            
            // 處理正負號
            let signStr = "";
            if (val < 0) signStr = "- ";
            else if (showSign && val >= 0) signStr = "+ ";
            
            let signW = textWidth(signStr);
            text(signStr, x, y); // 畫符號
            
            let currentX = x + signW;
            let widthUsed = signW;
            let centerX = currentX; // 預設中心

            // 判斷是整數還是分數
            if (f.d === 1) {
                // 整數模式
                text(absN, currentX, y);
                let numW = textWidth(absN.toString());
                widthUsed += numW;
                centerX = currentX + numW / 2;
            } else {
                // 分數模式 (垂直)
                textSize(fontSize * 0.85); // 分數數字稍微縮小
                let nStr = absN.toString();
                let dStr = absD.toString();
                let wN = textWidth(nStr);
                let wD = textWidth(dStr);
                let maxW = Math.max(wN, wD);
                let padding = 4;
                let barW = maxW + padding;

                // 畫分數線
                let midY = y - fontSize * 0.4; // 調整到算式中間高度
                stroke(color === 0 ? 0 : color); strokeWeight(1.5);
                line(currentX, midY, currentX + barW, midY);

                // 畫分子與分母
                noStroke();
                textAlign(CENTER, BOTTOM);
                text(nStr, currentX + barW/2, midY - 2);
                textAlign(CENTER, TOP);
                text(dStr, currentX + barW/2, midY + 4);

                // 復原對齊
                textAlign(LEFT, BASELINE);
                textSize(fontSize); // 復原字體大小

                widthUsed += barW;
                centerX = currentX + barW / 2;
            }

            return { width: widthUsed, centerX: centerX };
        }

        function draw() {
            background(255);
            fill(50); stroke(0); strokeWeight(0.5); textSize(24);
            
            let startX = 20;
            let startY = 70; // 增加上方留白給垂直分數
            let lh = 100;    // 增加行距，避免垂直分數打架

            // --- 第一行：題目 ---
            let cx = startX;
            text("y = ", cx, startY); cx += textWidth("y = ");
            
            if (A.val() !== 1) { // 係數為1不顯示
                if (A.val() === -1) { text("-", cx, startY); cx += textWidth("-"); }
                else cx += drawVerticalFraction(A, cx, startY).width;
            }
            
            text("x² ", cx, startY); cx += textWidth("x² ");
            cx += drawVerticalFraction(B, cx, startY, {showSign: true}).width;
            text("x ", cx, startY); cx += textWidth("x ");
            cx += drawVerticalFraction(C, cx, startY, {showSign: true}).width;

            // --- 第二行：提公因數 ---
            if (step >= 1) {
                let y2 = startY + lh;
                cx = startX;
                
                text("= ", cx, y2); cx += textWidth("= ");
                // 箭頭起點 A
                let posA = drawVerticalFraction(A, cx, y2);
                cx += posA.width;
                let arrowStartA = posA.centerX; 

                text("(x² ", cx, y2); cx += textWidth("(x² ");
                
                // 一次項係數 B/A (箭頭起點 B_div_A)
                let posBdivA = drawVerticalFraction(B_div_A, cx, y2, {showSign: true});
                cx += posBdivA.width;
                let arrowStartB = posBdivA.centerX;

                text("x", cx, y2); cx += textWidth("x");

                let gapStart = cx; // 紀錄空位起點
                let gapW = 80;     // 預留空位
                if (step >= 2) gapW = 100; // 有填數字時寬一點
                
                cx += gapW; 
                text(") ", cx, y2); cx += textWidth(") ");
                cx += drawVerticalFraction(C, cx, y2, {showSign: true}).width;
                let endOfLine2 = cx;

                // --- 第三行：配方補數與平衡 ---
                if (step >= 2) {
                    // 1. 填入補數 (藍色)
                    // 計算置中位置
                    let tempCX = gapStart + 10;
                    // 先計算寬度但不畫，為了置中 (這裡簡化，直接畫在 gapStart 偏移處)
                    let posSq = drawVerticalFraction(Half_B_Sq, gapStart + 10, y2, {showSign: true, color: 'blue'});
                    let arrowEndSq = posSq.centerX;

                    // 2. 填入平衡項 (藍色)
                    // 因為是扣掉 (A * 補數)，所以符號要變號
                    // 若 Balance 正 -> 減去 (顯示 - ...)
                    // 若 Balance 負 -> 減去負的 (顯示 + ...)
                    let balanceColor = 'blue';
                    let balanceSignStr = (Balance.val() >= 0) ? "- " : "+ ";
                    text(balanceSignStr, endOfLine2 + 10, y2);
                    let posBal = drawVerticalFraction(Balance.abs(), endOfLine2 + 10 + textWidth(balanceSignStr), y2, {color: 'blue'});
                    let arrowEndBal = posBal.centerX;

                    // 3. 紅色箭頭 (除以2再平方)
                    drawCurvedArrow(arrowStartB, y2 + 15, arrowEndSq, y2 + 15, "red");

                    // 4. 綠色箭頭 (平衡)
                    drawOverArrow(arrowStartA, y2 - 35, arrowEndBal, y2 - 35);
                }
            }

            // --- 第四行：整理 ---
            if (step >= 3) {
                let y3 = startY + lh * 2;
                cx = startX;
                text("= ", cx, y3); cx += textWidth("= ");
                cx += drawVerticalFraction(A, cx, y3).width;
                
                text("(x ", cx, y3); cx += textWidth("(x ");
                
                // 顯示一半的數 (Half_B)
                cx += drawVerticalFraction(Half_B, cx, y3, {showSign: true}).width;
                text(")² ", cx, y3); cx += textWidth(")² ");
                
                // 顯示常數項 K
                cx += drawVerticalFraction(Final_K, cx, y3, {showSign: true}).width;
            }

            // --- 第五行：頂點 ---
            if (step >= 4) {
                let y4 = startY + lh * 3;
                cx = startX;
                fill(230, 126, 34); textStyle(BOLD); textSize(30);
                text("V ( ", cx, y4); cx += textWidth("V ( ");
                
                // 頂點 X = -Half_B
                let vx = new Fraction(-Half_B.n, Half_B.d);
                // 這裡要用黑色或橘色畫分數？既然是重點用橘色
                // 但 drawVerticalFraction 預設黑色，我們傳入 color
                cx += drawVerticalFraction(vx, cx, y4, {color: '#e67e22', fontSize: 30}).width;
                
                text(" , ", cx, y4); cx += textWidth(" , ");
                cx += drawVerticalFraction(Final_K, cx, y4, {color: '#e67e22', fontSize: 30}).width;
                text(" )", cx, y4);
                textStyle(NORMAL);
            }
        }

        // 繪圖輔助
        function drawCurvedArrow(x1, y1, x2, y2, color) {
            push(); noFill(); stroke(color); strokeWeight(2);
            beginShape(); vertex(x1, y1); vertex(x1, y1 + 35); vertex(x2, y1 + 35); vertex(x2, y2 + 15); endShape();
            translate(x2, y2 + 10); fill(color); noStroke(); triangle(-5, 8, 5, 8, 0, -2); // 朝上
            pop();
            // 文字
            noStroke(); fill(color); textSize(14); textAlign(CENTER);
            text("除以2再平方", (x1+x2)/2, y1 + 55);
        }

        function drawOverArrow(x1, y1, x2, y2) {
            push(); noFill(); stroke(46, 125, 50); strokeWeight(2);
            let h = 50; // 拱高
            bezier(x1, y1, x1, y1 - h, x2, y2 - h, x2, y2);
            translate(x2, y2); rotate(PI/2); fill(46, 125, 50); noStroke(); triangle(-5, -10, 5, -10, 0, 0);
            pop();
        }

        function nextStep() { if(step < totalSteps) { step++; updateBtn(); } }
        function prevStep() { if(step > 0) { step--; updateBtn(); } }
        function resetAnimation() { step = 0; updateBtn(); }
        function updateBtn() {
            document.getElementById('prevBtn').disabled = (step === 0);
            document.getElementById('nextBtn').disabled = (step === totalSteps);
            let steps = ["1. 題目展示", "2. 提出係數 a", "3. 配方補項與平衡", "4. 整理成完全平方式", "5. 寫出頂點座標"];
            document.getElementById('step-desc').innerText = steps[step];
            redraw();
        }
    </script>
</body>
</html>