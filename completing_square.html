<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配方法演示 (垂直分數最終完美版)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/nerdamer.core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Algebra.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Calculus.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary: #2e7d32; --secondary: #e67e22; --bg: #f4f7f6; --text: #333; }
        body { font-family: 'Noto Sans TC', sans-serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .main-layout { display: flex; flex: 1; height: 100%; }
        .canvas-area { flex: 2; background: white; display: flex; flex-direction: column; align-items: center; padding: 20px; border-right: 1px solid #ddd; overflow-y: auto; }
        .controls-area { flex: 1; background: #fafafa; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; min-width: 300px; box-shadow: -5px 0 15px rgba(0,0,0,0.05); }
        .input-group { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; }
        .input-label { font-weight: bold; font-size: 1.2em; width: 40px; }
        input[type="text"] { width: 100%; padding: 8px; font-size: 18px; border: 1px solid #ccc; border-radius: 5px; font-family: 'Courier New', monospace; text-align: center; }
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: var(--primary); color: white; border: none; border-radius: 5px; font-weight: bold; transition: 0.2s; }
        button:hover { filter: brightness(1.1); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #canvas-wrapper { width: 100%; display: flex; justify-content: center; margin-bottom: 20px; }
        .explanation-box { margin-top: auto; padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid var(--primary); font-size: 0.9em; width: 90%; }
        @media (max-width: 768px) { .main-layout { flex-direction: column-reverse; } .canvas-area { border-right: none; border-top: 1px solid #ddd; } }
    </style>
</head>
<body>

    <div class="main-layout">
        <div class="canvas-area">
            <h2 style="color: var(--primary); margin-bottom: 10px;">配方法演示 (垂直分數最終版)</h2>
            <div id="canvas-wrapper"></div>
            <div class="explanation-box"><b>當前步驟：</b> <span id="step-desc">準備開始...</span></div>
        </div>

        <div class="controls-area">
            <h3 style="margin-top:0"><i class="fas fa-superscript"></i> 設定係數</h3>
            <p style="color:#666; font-size:0.9em;">支援任意代數，自動轉為標準分數格式。</p>
            
            <div class="input-group"><div class="input-label">a =</div><input type="text" id="input_a" value="2" oninput="updateMath()"></div>
            <div class="input-group"><div class="input-label">b =</div><input type="text" id="input_b" value="k" oninput="updateMath()"></div>
            <div class="input-group"><div class="input-label">c =</div><input type="text" id="input_c" value="1" oninput="updateMath()"></div>

            <div class="btn-group">
                <button id="prevBtn" onclick="prevStep()">上一步</button>
                <button id="nextBtn" onclick="nextStep()">下一步</button>
            </div>
            <div class="btn-group"><button id="resetBtn" onclick="resetAnimation()" style="width:100%">重置步驟</button></div>
        </div>
    </div>

    <script>
        let step = 0; let totalSteps = 4;
        let rawA, rawB, rawC, raw_B_div_A, raw_Half, raw_Half_Sq, raw_Balance, raw_K;

        function setup() {
            let canvas = createCanvas(600, 550);
            canvas.parent('canvas-wrapper');
            textFont('Noto Sans TC');
            updateMath();
        }

        function windowResized() {
            let w = document.querySelector('.canvas-area').clientWidth - 40;
            resizeCanvas(min(w, 700), 550);
        }

        function updateMath() {
            let strA = document.getElementById('input_a').value || "1";
            let strB = document.getElementById('input_b').value || "0";
            let strC = document.getElementById('input_c').value || "0";
            try {
                rawA = strA; rawB = strB; rawC = strC;
                // 使用 expand() 確保結構展開
                raw_B_div_A = nerdamer(`(${strB})/(${strA})`).expand().text();
                raw_Half = nerdamer(`(${raw_B_div_A})/2`).expand().text();
                raw_Half_Sq = nerdamer(`(${raw_Half})^2`).expand().text();
                
                // 平衡項 (計算其負值以便顯示)
                let balance = nerdamer(`(${strA}) * (${raw_Half_Sq})`).expand().text();
                raw_Balance = nerdamer(`-1 * (${balance})`).expand().text(); 
                
                raw_K = nerdamer(`(${strC}) - (${balance})`).expand().text();
                redraw();
            } catch (e) { console.log(e); }
        }

        // --- 核心：使用 Nerdamer 引擎解析分子分母 ---
        // 這是解決負指數與分數顯示的最強方案
        function formatMonomial(str) {
            try {
                // 1. 建立 Nerdamer 物件
                let term = nerdamer(str);
                
                // 2. 直接獲取分子與分母 (強制轉為分數格式)
                // text('fractions') 會把 0.25 轉成 1/4，把 a^-1 轉成 1/a
                let num = term.numerator().text('fractions');
                let den = term.denominator().text('fractions');
                
                // 3. 回傳結果
                return {
                    num: num,
                    den: den,
                    isFraction: den !== '1' // 如果分母不是 1，就是分數
                };
            } catch (e) {
                return { num: str, den: '1', isFraction: false };
            }
        }

        // --- 繪圖：多項式字串 (處理 ^ 上標與 * 隱藏) ---
        function drawPoly(str, x, y, size, measureOnly = false) {
            let cursorX = x;
            // 移除乘號
            let displayStr = str.replace(/\*/g, '');
            
            // 清理多餘外層括號
            if (displayStr.length > 2 && displayStr.startsWith('(') && displayStr.endsWith(')')) {
                 let d = 0, ok = true;
                 for(let i=0; i<displayStr.length-1; i++){
                     if(displayStr[i]=='(') d++;
                     if(displayStr[i]==')') d--;
                     if(d==0) { ok=false; break; }
                 }
                 if(ok) displayStr = displayStr.substring(1, displayStr.length-1);
            }

            if (!measureOnly) { textSize(size); noStroke(); }
            
            for (let i = 0; i < displayStr.length; i++) {
                let char = displayStr[i];
                if (char === '^') {
                    // 上標處理
                    let nextChar = displayStr[i+1];
                    let superscript = nextChar;
                    let skip = 1;
                    if (i+1 < displayStr.length) {
                        let sub = displayStr.substring(i+1);
                        // 匹配整數或負整數
                        let m = sub.match(/^(-?\d+)/);
                        if (m) { superscript = m[1]; skip = m[0].length; }
                        else if (nextChar === '(') {
                             let end = displayStr.indexOf(')', i+2);
                             if(end!=-1) { superscript = displayStr.substring(i+2, end); skip = end - i; }
                        }
                    }
                    if (!measureOnly) {
                        textSize(size * 0.7);
                        text(superscript, cursorX, y - size * 0.35);
                        textSize(size);
                    }
                    cursorX += textWidth(superscript) * 0.75;
                    i += skip;
                } else if (char === '+' || char === '-') {
                    // 運算符號加點間距
                    let w = textWidth(char);
                    if (!measureOnly) text(char, cursorX + 2, y);
                    cursorX += w + 6;
                } else {
                    let w = textWidth(char);
                    if (!measureOnly) text(char, cursorX, y);
                    cursorX += w + 1;
                }
            }
            return cursorX - x;
        }

        // --- 繪圖：智能數學項 (自動拆解多項式並垂直顯示) ---
        function drawSmartTerm(rawStr, x, y, options = {}) {
            let { showSign = false, color = 0, fontSize = 24, measureOnly = false } = options;
            if (!measureOnly) { fill(color); stroke(0); strokeWeight(0); textSize(fontSize); }
            else textSize(fontSize);

            let cursorX = x;

            // 1. 拆解多項式 (依據 + 或 - 分割)
            let cleanRaw = rawStr.replace(/\s/g, ''); 
            // 修正：保留乘號，確保 nerdamer 解析正確
            
            let tempStr = cleanRaw;
            if (tempStr.startsWith('-')) tempStr = tempStr.substring(1); 
            
            // 簡易分割：除了括號內的 +/-，其他都分割
            let terms = tempStr.replace(/([^+])([+-])/g, '$1@$2').split('@');
            
            if (cleanRaw.startsWith('-')) terms[0] = '-' + terms[0];

            terms.forEach((term, index) => {
                let isNeg = term.startsWith('-');
                let absTerm = isNeg ? term.substring(1) : (term.startsWith('+') ? term.substring(1) : term);
                
                // 決定符號
                let signToDraw = "";
                if (index === 0) {
                    if (isNeg) signToDraw = "- ";
                    else if (showSign) signToDraw = "+ ";
                } else {
                    signToDraw = isNeg ? " - " : " + ";
                }

                if (signToDraw) {
                    let sw = textWidth(signToDraw);
                    if (!measureOnly) text(signToDraw, cursorX, y);
                    cursorX += sw;
                }

                // 2. 格式化 (Nerdamer 核心)
                // 這裡傳入的 term 可能含有 *，這是好事！
                let fmt = formatMonomial(absTerm);
                
                if (!fmt.isFraction) {
                    // 整式
                    let w = drawPoly(fmt.num, cursorX, y, fontSize, measureOnly);
                    cursorX += w;
                } else {
                    // 分數
                    let wN = drawPoly(fmt.num, 0, 0, fontSize*0.85, true);
                    let wD = drawPoly(fmt.den, 0, 0, fontSize*0.85, true);
                    let maxW = Math.max(wN, wD) + 10;
                    
                    if (!measureOnly) {
                        let midY = y - fontSize * 0.4;
                        stroke(color === 0 ? 0 : color); strokeWeight(1.5);
                        line(cursorX, midY, cursorX + maxW, midY); // 分數線
                        noStroke();
                        
                        let nx = cursorX + (maxW - wN)/2;
                        drawPoly(fmt.num, nx, midY - 6, fontSize*0.85, false);
                        
                        let dx = cursorX + (maxW - wD)/2;
                        drawPoly(fmt.den, dx, midY + fontSize*0.85 + 4, fontSize*0.85, false);
                        textSize(fontSize);
                    }
                    cursorX += maxW;
                }
            });

            return { width: cursorX - x, centerX: x + (cursorX - x)/2 };
        }

        function draw() {
            background(255);
            fill(50); stroke(0); strokeWeight(0.5); textSize(24);
            
            let startX = 20; let startY = 80; let lh = 150; let p = 10; 

            // Line 1: y = ax^2 + bx + c
            let cx = startX;
            text("y = ", cx, startY); cx += textWidth("y = ") + p;
            if (rawA !== "1") cx += drawSmartTerm(rawA, cx, startY).width + p;
            cx += drawPoly("x^2", cx, startY, 24, false) + p;
            cx += drawSmartTerm(rawB, cx, startY, {showSign: true}).width + p;
            text("x ", cx, startY); cx += textWidth("x ") + p;
            cx += drawSmartTerm(rawC, cx, startY, {showSign: true}).width;

            // Line 2
            if (step >= 1) {
                let y2 = startY + lh; cx = startX;
                text("= ", cx, y2); cx += textWidth("= ") + p;
                let posA = drawSmartTerm(rawA, cx, y2); cx += posA.width + p;
                let arrowStartA = posA.centerX; 
                text("( ", cx, y2); cx += textWidth("( ");
                cx += drawPoly("x^2", cx, y2, 24, false) + p;
                
                let posBdivA = drawSmartTerm(raw_B_div_A, cx, y2, {showSign: true});
                cx += posBdivA.width + p;
                let arrowStartB = posBdivA.centerX;
                text("x", cx, y2); cx += textWidth("x") + p;

                let gapStart = cx;
                let sqWidth = drawSmartTerm(raw_Half_Sq, 0, 0, {showSign: true, measureOnly: true}).width;
                let gapW = (step >= 2) ? (sqWidth + 70) : 100;
                cx += gapW; 
                text(") ", cx, y2); cx += textWidth(") ") + p;
                cx += drawSmartTerm(rawC, cx, y2, {showSign: true}).width;
                let endOfLine2 = cx;

                if (step >= 2) {
                    let x_centered = gapStart + (gapW - sqWidth) / 2;
                    let posSq = drawSmartTerm(raw_Half_Sq, x_centered, y2, {showSign: true, color: 'blue'});
                    let arrowEndSq = posSq.centerX;

                    let posBal = drawSmartTerm(raw_Balance, endOfLine2 + 20, y2, {showSign: true, color: 'blue'});
                    let arrowEndBal = posBal.centerX;

                    drawCurvedArrow(arrowStartB, y2 + 15, arrowEndSq, y2 + 15, "red");
                    drawOverArrow(arrowStartA, y2 - 50, arrowEndBal, y2 - 50);
                }
            }

            // Line 3
            if (step >= 3) {
                let y3 = startY + lh * 2; cx = startX;
                text("= ", cx, y3); cx += textWidth("= ") + p;
                cx += drawSmartTerm(rawA, cx, y3).width + p;
                text("( x ", cx, y3); cx += textWidth("( x ") + p;
                cx += drawSmartTerm(raw_Half, cx, y3, {showSign: true}).width + p;
                text(")", cx, y3); cx += textWidth(")");
                cx += drawPoly("^2", cx, y3, 24, false) + p;
                cx += drawSmartTerm(raw_K, cx, y3, {showSign: true}).width;
            }

            // Line 4
            if (step >= 4) {
                let y4 = startY + lh * 3; cx = startX;
                fill(230, 126, 34); textStyle(BOLD); textSize(30);
                text("V ( ", cx, y4); cx += textWidth("V ( ") + p;
                let negHalf = nerdamer(`-1 * (${raw_Half})`).expand().text();
                cx += drawSmartTerm(negHalf, cx, y4, {color: '#e67e22', fontSize: 30}).width + p;
                text(" , ", cx, y4); cx += textWidth(" , ") + p;
                cx += drawSmartTerm(raw_K, cx, y4, {color: '#e67e22', fontSize: 30}).width + p;
                text(" )", cx, y4);
                textStyle(NORMAL);
            }
        }

        function drawCurvedArrow(x1, y1, x2, y2, color) {
            push(); noFill(); stroke(color); strokeWeight(2);
            beginShape(); vertex(x1, y1); vertex(x1, y1 + 45); vertex(x2, y1 + 45); vertex(x2, y2 + 15); endShape();
            translate(x2, y2 + 10); fill(color); noStroke(); triangle(-5, 8, 5, 8, 0, -2); pop();
            noStroke(); fill(color); textSize(14); textAlign(CENTER);
            text("除以2再平方", (x1+x2)/2, y1 + 65); 
        }

        function drawOverArrow(x1, y1, x2, y2) {
            push(); noFill(); stroke(46, 125, 50); strokeWeight(2);
            let h = 60; 
            bezier(x1, y1, x1, y1 - h, x2, y2 - h, x2, y2);
            translate(x2, y2); rotate(PI/2); fill(46, 125, 50); noStroke(); triangle(-5, -10, 5, -10, 0, 0); pop();
        }

        function nextStep() { if(step < totalSteps) { step++; updateBtn(); } }
        function prevStep() { if(step > 0) { step--; updateBtn(); } }
        function resetAnimation() { step = 0; updateBtn(); }
        function updateBtn() {
            document.getElementById('prevBtn').disabled = (step === 0);
            document.getElementById('nextBtn').disabled = (step === totalSteps);
            let steps = ["1. 題目展示", "2. 提出係數 a", "3. 配方補項與平衡", "4. 整理成完全平方式", "5. 寫出頂點座標"];
            document.getElementById('step-desc').innerText = steps[step];
            redraw();
        }
    </script>
</body>
</html>